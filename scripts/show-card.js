let xebia_essential = {
  domain: "https://essentials.xebia.com/",
  cards: [
    { href: "/apis-are-forever/", title: "APIs, like diamonds, are forever", category: "Realisation" },
    { href: "/thread-safe/", title: "Aim for thread safety", category: "Realisation" },
    { href: "/alone-time/", title: "Alone time", category: "Collaboration" },
    { href: "/assertions/", title: "Assert against improper behaviour", category: "Realisation" },
    { href: "/automate-everything/", title: "Automate the entire release and deployment process", category: "Realisation" },
    { href: "/curiosity/", title: "Be curious", category: "Craftsmanship" },
    { href: "/no-anemic-domain-model/", title: "Beware of anemic domain models", category: "Realisation" },
    { href: "/brutal-transparency/", title: "Brutal Transparency", category: "Collaboration" },
    { href: "/comment-with-care/", title: "Comment with care", category: "Craftsmanship" },
    { href: "/dare-to-say-no/", title: "Dare to say no", category: "Craftsmanship" },
    { href: "/non-functionals/", title: "Deal with non-functionals", category: "Realisation" },
    { href: "/secure-development/", title: "Develop for security", category: "Realisation" },
    { href: "/diagnose-before-cure/", title: "Diagnose before cure", category: "Craftsmanship" },
    { href: "/dry-principle/", title: "Don't Repeat Yourself", category: "Craftsmanship" },
    { href: "/done-is-live/", title: "Done = Live!", category: "Collaboration" },
    { href: "/eliminate-waste/", title: "Eliminate waste", category: "Collaboration" },
    { href: "/fail-fast/", title: "Fail fast", category: "Testing" },
    { href: "/composition-over-inheritance/", title: "Favor composition over inheritance", category: "Realisation" },
    { href: "/improve-continuously/", title: "Favor continuous improvement over delayed perfection", category: "Craftsmanship" },
    { href: "/genchi-genbutsu/", title: "Find the root cause", category: "Craftsmanship" },
    { href: "/focus-on-flow/", title: "Focus on flow", category: "Collaboration" },
    { href: "/team-rhythm/", title: "Get the team in a rhythm", category: "Collaboration" },
    { href: "/have-fun/", title: "Have fun", category: "Collaboration" },
    { href: "/hurt-often/", title: "If it hurts, do it more often", category: "Collaboration" },
    { href: "/poutsma-principle/", title: "If something is too complex to understand, it must be wrong", category: "Realisation" },
    {
      href: "/two-minute-rule/",
      title: "If you are stuck developing for more than two minutes, you MUST ask somebody else",
      category: "Craftsmanship"
    },
    { href: "/context-over-habit/", title: "Improve practices, don't just follow the recipe", category: "Craftsmanship" },
    { href: "/integrate-early/", title: "Integrate early", category: "Realisation" },
    { href: "/done/", title: "It ain't over till it's done", category: "Collaboration" },
    { href: "/team-member-equality/", title: "Judge on content, not on authority", category: "Collaboration" },
    { href: "/clean-build/", title: "Keep the build clean", category: "Craftsmanship" },
    { href: "/hands-off-machine/", title: "Keep your hands off the machine", category: "Realisation" },
    { href: "/clean-logs/", title: "Keep your logs clean", category: "Testing" },
    { href: "/learn-a-new-language/", title: "Learn a new language every year", category: "Craftsmanship" },
    { href: "/boy-scout-rule/", title: "Leave the campground cleaner than you found it", category: "Realisation" },
    { href: "/make-it-visible/", title: "Make it visible", category: "Collaboration" },
    { href: "/make-it-work-right-fast/", title: "Make it work Make it right Make it fast", category: "Craftsmanship" },
    { href: "/exploratory-testing/", title: "Make room for exploratory testing", category: "Testing" },
    { href: "/master-your-tools/", title: "Master your tools", category: "Craftsmanship" },
    { href: "/maximize-cohesion-minimize-coupling/", title: "Maximize cohesion Minimize coupling", category: "Realisation" },
    { href: "/no-blame-no-mercy/", title: "No blame, but no mercy", category: "Collaboration" },
    { href: "/no-broken-windows/", title: "No broken windows", category: "Collaboration" },
    { href: "/no-test-no-bugfix/", title: "No change without a failing test", category: "Craftsmanship" },
    { href: "/no-multitasking/", title: "No multitasking", category: "Craftsmanship" },
    { href: "/one-change-at-a-time/", title: "One change at a time", category: "Craftsmanship" },
    { href: "/one-feature-at-a-time/", title: "One feature at a time", category: "Collaboration" },
    { href: "/pair-programming/", title: "Pair programming", category: "Collaboration" },
    { href: "/rich-communication/", title: "Prefer rich modes of communication", category: "Craftsmanship" },
    { href: "/no-museum/", title: "Prevent your code base from turning into a museum", category: "Craftsmanship" },
    { href: "/fallacies-distributed-computing/", title: "Remember the fallacies of distributed computing", category: "Realisation" },
    { href: "/the-zone/", title: "Respect the zone", category: "Collaboration" },
    { href: "/code-review/", title: "Review code", category: "Collaboration" },
    { href: "/run-tests-automatically/", title: "Run tests automatically" },
    { href: "/separation-of-concerns/", title: "Separation of concerns", category: "Realisation" },
    { href: "/shared-design-understanding/", title: "Share the design", category: "Realisation" },
    { href: "/no-broken-builds/", title: "Sleep easy on a green build", category: "Collaboration" },
    { href: "/thirty-minute-methods/", title: "Split functionality into small units", category: "Realisation" },
    { href: "/acceptance-criteria/", title: "Start with acceptance criteria", category: "Testing" },
    { href: "/time-for-tech-debt/", title: "Take time to tackle tech debt", category: "Craftsmanship" },
    { href: "/tdd-shapes-design/", title: "Test Driven Development shapes design", category: "Testing" },
    { href: "/testing-is-shared-responsibility/", title: "Tes`ting is a shared responsibility", category: "Testing" },
    { href: "/tests-are-specs/", title: "Tests are Specifications", category: "Testing" },
    { href: "/independent-tests/", title: "Tests should be fast, reliable and independent", category: "Testing" },
    { href: "/test-code-one/", title: "Think of code and test as one", category: "Testing" },
    { href: "/three-strikes/", title: "Three strikes and you automate", category: "Craftsmanship" },
    { href: "/timebox/", title: "Timebox the unknown", category: "Collaboration" },
    { href: "/test-everything/", title: "When you don't have time to test everything, you're building too much", category: "Testing" },
    { href: "/small-increments/", title: "Work in small increments", category: "Craftsmanship" },
    { href: "/definition-of-ready/", title: "Work on stories when they're ready", category: "Collaboration" },
    { href: "/readable-code/", title: "Write code that humans can easily understand", category: "Craftsmanship" },
    { href: "/focused-interfaces/", title: "Write small and focused interfaces", category: "Realisation" },
    { href: "/build-it-run-it/", title: "You build it, you run it!", category: "Collaboration" },
    { href: "/what-you-measure/", title: "You get what you measure", category: "Collaboration" },
    { href: "/kiss/", title: "Your solution should not be more complicated than the problem", category: "Realisation" }
  ]
};

const DEFAULT_XEBIA_STORAGE = {
  unseenCards: [],
};


chrome.action.onClicked.addListener(async (tab) => {
  show_new_card();
});

function show_new_card() {
  chrome.storage.sync.get({"xebiaStateStorageKey": DEFAULT_XEBIA_STORAGE}).then((result) => {
    let xebiaState = result.xebiaStateStorageKey;
    let unseenCards = xebiaState.unseenCards;
    if (!unseenCards || unseenCards.length === 0) {
      unseenCards = Array.apply(null, Array(xebia_essential.cards.length)).map(function (x, i) {
        return i;
      });
    }
    let unseenCardIndex = Math.floor(Math.random() * unseenCards.length);
    let card = xebia_essential.cards[unseenCards[unseenCardIndex]];
    chrome.tabs.create({ url: xebia_essential.domain + card.href });
    unseenCards.splice(unseenCardIndex, 1);
    xebiaState.unseenCards = unseenCards;
    chrome.storage.sync.set({ xebiaStateStorageKey: xebiaState }).then(() => {
    });
  });
}

function reset() {
  chrome.storage.sync.set({
    xebiaStateStorageKey: DEFAULT_XEBIA_STORAGE
  }).then(() => {});
}

